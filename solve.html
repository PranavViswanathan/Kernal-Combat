<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solve Problem - Kernal Combat Terminal</title>
    <meta name="description" content="Code editor for solving problems">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=VT323&display=swap"
        rel="stylesheet">

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">

    <style>
        .CodeMirror {
            height: 400px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            background: var(--terminal-bg);
            color: var(--terminal-text);
            border: 1px solid var(--terminal-border);
        }

        .CodeMirror-gutters {
            background: var(--terminal-bg-alt);
            border-right: 1px solid var(--terminal-border);
        }

        .CodeMirror-linenumber {
            color: var(--terminal-text-dim);
        }

        .CodeMirror-cursor {
            border-left-color: var(--accent-primary);
        }

        .CodeMirror-selected {
            background: rgba(0, 255, 65, 0.1);
        }
    </style>
</head>

<body>
    <div class="terminal-container">
        <div class="terminal-header">
            <div class="terminal-buttons">
                <span class="terminal-button close"></span>
                <span class="terminal-button minimize"></span>
                <span class="terminal-button maximize"></span>
            </div>
            <div class="terminal-title">
                <span class="blink">‚ñà</span> <span id="problemTitle">Problem</span>
            </div>
            <div class="terminal-actions">
                <button class="terminal-btn" onclick="navigateTo('problems.html')">
                    <span class="icon">üìÅ</span> Back
                </button>
                <button class="terminal-btn btn-primary" onclick="runCode()">
                    <span class="icon">‚ñ∂Ô∏è</span> Run
                </button>
            </div>
        </div>

        <div class="terminal-body">
            <div class="editor-container">
                <!-- Problem Description -->
                <div class="editor-panel">
                    <div class="panel-header">üìù Problem Description</div>
                    <div class="panel-content">
                        <div id="problemDescription">
                            <p>Loading problem...</p>
                        </div>

                        <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--terminal-text-bright);">
                            Test Cases:
                        </h3>
                        <div id="testCases"></div>
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="editor-panel">
                    <div class="panel-header">
                        üíª Code Editor
                        <select id="languageSelector" onchange="changeLanguage()"
                            style="margin-left: 20px; background: var(--terminal-bg); color: var(--accent-primary); border: 1px solid var(--terminal-border); padding: 5px 10px; border-radius: 4px; font-family: 'Fira Code', monospace; cursor: pointer;">
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                        </select>
                        <span style="margin-left: auto; font-size: 12px; color: var(--terminal-text-dim);">
                            Time: <span id="timer">0:00</span>
                        </span>
                    </div>
                    <div class="panel-content" style="padding: 0;">
                        <div id="codeEditor"></div>
                    </div>
                    <div style="padding: 16px; border-top: 1px solid var(--terminal-border);">
                        <button class="btn btn-primary" onclick="runCode()" style="width: 100%;">
                            ‚ñ∂Ô∏è Run Tests
                        </button>
                        <button class="btn" onclick="submitSolution()" style="width: 100%; margin-top: 10px;">
                            ‚úÖ Submit Solution
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="editor-panel mt-20">
                <div class="panel-header">üìä Test Results</div>
                <div class="panel-content" id="results">
                    <p class="info-line">
                        <span class="prompt">$</span> Run your code to see results...
                    </p>
                </div>
            </div>
        </div>

        <div class="terminal-footer">
            <div class="status-bar">
                <span class="status-item">
                    <span class="status-dot active"></span> CODING
                </span>
                <span class="status-item">
                    Lines: <span id="lineCount">0</span>
                </span>
                <span class="status-item">
                    TIME: <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

    <script src="problemLoader.js?v=2"></script>
    <script src="app.js?v=2"></script>
    <script>
        let currentProblem = null;
        let startTime = Date.now();
        let timerInterval = null;
        let codeEditor = null;
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'javascript';

        // Language configuration
        const LANGUAGE_CONFIG = {
            javascript: { mode: 'javascript', extension: 'js', icon: 'üü®' },
            python: { mode: 'python', extension: 'py', icon: 'üêç' },
            java: { mode: 'text/x-java', extension: 'java', icon: '‚òï' },
            cpp: { mode: 'text/x-c++src', extension: 'cpp', icon: '‚öôÔ∏è' }
        };

        function getDifficultyClass(difficulty) {
            return `difficulty-${difficulty}`;
        }

        async function loadProblem() {
            try {
                console.log('üöÄ Starting loadProblem...');
                const topic = localStorage.getItem('currentTopic');
                const problemId = localStorage.getItem('currentProblem');
                console.log(`üìç Topic: ${topic}, ProblemId: ${problemId}`);

                if (!topic || !problemId) {
                    console.warn('‚ö†Ô∏è Missing topic or problemId, redirecting to problems.html');
                    window.location.href = 'problems.html';
                    return;
                }

                // Load problem dynamically
                console.log('üîÑ Calling getProblem...');
                currentProblem = await getProblem(topic, problemId);
                console.log('‚úÖ Got problem data:', currentProblem);

                if (!currentProblem) {
                    console.error('‚ùå Problem not found!');
                    alert('Problem not found!');
                    window.location.href = 'problems.html';
                    return;
                }

                // Set title
                console.log('üìù Setting problem title...');
                const titleEl = document.getElementById('problemTitle');
                if (titleEl) titleEl.textContent = currentProblem.name;

                // Set description
                console.log('üìù Setting problem description...');
                const descEl = document.getElementById('problemDescription');
                if (descEl) {
                    descEl.innerHTML = `
                        <h2 style="color: var(--terminal-text-bright); margin-bottom: 15px;">
                            ${currentProblem.name}
                        </h2>
                        <span class="problem-difficulty ${getDifficultyClass(currentProblem.difficulty)}" 
                              style="display: inline-block; margin-bottom: 15px;">
                            ${currentProblem.difficulty.toUpperCase()}
                        </span>
                        <p style="line-height: 1.8;">${currentProblem.description}</p>
                        ${currentProblem.hints ? `
                            <details style="margin-top: 20px;">
                                <summary style="cursor: pointer; color: var(--accent-secondary);">üí° Hints</summary>
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    ${currentProblem.hints.map(hint => `<li>${hint}</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    `;
                } else {
                    console.error('‚ùå problemDescription element not found!');
                }

                // Set test cases
                console.log('üß™ Setting test cases...');
                const testCasesDiv = document.getElementById('testCases');
                if (testCasesDiv) {
                    testCasesDiv.innerHTML = '';
                    if (currentProblem.testCases && Array.isArray(currentProblem.testCases)) {
                        currentProblem.testCases.forEach((tc, idx) => {
                            const testDiv = document.createElement('div');
                            testDiv.className = 'test-case';
                            testDiv.innerHTML = `
                                <div class="test-label">Test Case ${idx + 1}:</div>
                                <div><strong>Input:</strong> ${tc.input}</div>
                                <div><strong>Expected Output:</strong> ${tc.output}</div>
                                ${tc.explanation ? `<div style="margin-top: 5px; color: var(--terminal-text-dim);"><em>${tc.explanation}</em></div>` : ''}
                            `;
                            testCasesDiv.appendChild(testDiv);
                        });
                    } else {
                        console.warn('‚ö†Ô∏è No test cases found or invalid format');
                        testCasesDiv.innerHTML = '<p class="error">No test cases available.</p>';
                    }
                } else {
                    console.error('‚ùå testCases element not found!');
                }

                // Initialize CodeMirror
                console.log('‚ú® About to call initializeCodeEditor...');
                initializeCodeEditor();
                console.log('üéâ loadProblem completed successfully');

            } catch (error) {
                console.error('üî• CRITICAL ERROR in loadProblem:', error);
                alert('Error loading problem. Check console for details.');
            }
        }

        function initializeCodeEditor() {
            console.log('Initializing CodeMirror editor...');
            const editorDiv = document.getElementById('codeEditor');

            if (!editorDiv) {
                console.error('Editor div not found!');
                return;
            }

            if (!currentProblem) {
                console.error('No current problem set!');
                return;
            }

            console.log('Current problem:', currentProblem);

            // Set language selector
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                languageSelector.value = currentLanguage;
            }

            // Load saved code or use starter code
            const savedCode = localStorage.getItem(`code_${currentProblem.id}_${currentLanguage}`);
            let initialCode = savedCode;

            if (!savedCode) {
                // Get starter code for current language
                if (typeof currentProblem.starterCode === 'object' && currentProblem.starterCode !== null) {
                    initialCode = currentProblem.starterCode[currentLanguage] || getDefaultStarterCode(currentLanguage);
                } else {
                    // Fallback for old format
                    initialCode = currentProblem.starterCode || getDefaultStarterCode(currentLanguage);
                }
            }

            console.log('Initial code length:', initialCode.length);

            try {
                codeEditor = CodeMirror(editorDiv, {
                    value: initialCode,
                    mode: LANGUAGE_CONFIG[currentLanguage].mode,
                    theme: 'dracula',
                    lineNumbers: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    indentWithTabs: false,
                    lineWrapping: true,
                    styleActiveLine: true,
                    extraKeys: {
                        'Ctrl-Space': 'autocomplete',
                        'Cmd-Space': 'autocomplete'
                    }
                });

                console.log('‚úÖ CodeMirror initialized successfully');

                // Auto-save code on change
                codeEditor.on('change', () => {
                    localStorage.setItem(`code_${currentProblem.id}_${currentLanguage}`, codeEditor.getValue());
                    updateLineCount();
                });

                // Initial line count
                updateLineCount();
            } catch (error) {
                console.error('Error initializing CodeMirror:', error);
            }
        }

        function getDefaultStarterCode(language) {
            const templates = {
                javascript: '// Write your solution here\n\nfunction solution() {\n    // Your code here\n}',
                python: '# Write your solution here\n\ndef solution():\n    # Your code here\n    pass',
                java: '// Write your solution here\n\nclass Solution {\n    public void solution() {\n        // Your code here\n    }\n}',
                cpp: '// Write your solution here\n\n#include <iostream>\nusing namespace std;\n\nvoid solution() {\n    // Your code here\n}'
            };
            return templates[language] || templates.javascript;
        }

        function changeLanguage() {
            const languageSelector = document.getElementById('languageSelector');
            const newLanguage = languageSelector.value;

            if (newLanguage === currentLanguage) return;

            // Save current code before switching
            if (codeEditor && currentProblem) {
                localStorage.setItem(`code_${currentProblem.id}_${currentLanguage}`, codeEditor.getValue());
            }

            currentLanguage = newLanguage;
            localStorage.setItem('selectedLanguage', newLanguage);

            // Get starter code for new language
            const savedCode = localStorage.getItem(`code_${currentProblem.id}_${currentLanguage}`);
            let newCode = savedCode;

            if (!savedCode) {
                if (typeof currentProblem.starterCode === 'object' && currentProblem.starterCode !== null) {
                    newCode = currentProblem.starterCode[currentLanguage] || getDefaultStarterCode(currentLanguage);
                } else {
                    newCode = getDefaultStarterCode(currentLanguage);
                }
            }

            // Update CodeMirror mode and value
            codeEditor.setOption('mode', LANGUAGE_CONFIG[currentLanguage].mode);
            codeEditor.setValue(newCode);
        }

        function runCode() {
            if (!codeEditor) return;

            const code = codeEditor.getValue();
            const resultsDiv = document.getElementById('results');

            // Only JavaScript can execute client-side
            if (currentLanguage !== 'javascript') {
                resultsDiv.innerHTML = `
                    <div class="test-case failed">
                        <div class="test-label">‚ö†Ô∏è Language Not Supported for Execution</div>
                        <p style="color: var(--terminal-text-dim);">
                            Currently, only JavaScript can execute in the browser. 
                            Python, Java, and C++ require a backend server.
                        </p>
                    </div>
                `;
                return;
            }

            // Save code
            localStorage.setItem(`code_${currentProblem.id}_${currentLanguage}`, code);

            // Show running state
            resultsDiv.innerHTML = '<p class="info-line"><span class="prompt">$</span> Running tests...</p>';

            // Execute tests after a brief delay to show the "running" message
            setTimeout(() => {
                try {
                    const testResults = executeJavaScriptTests(code, currentProblem.testCases);
                    displayTestResults(testResults);
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="test-case failed">
                            <div class="test-label">‚ùå Execution Error</div>
                            <pre style="color: var(--error); margin-top: 10px;">${error.message}</pre>
                        </div>
                    `;
                }
            }, 500);
        }

        function executeJavaScriptTests(code, testCases) {
            const results = [];
            let allPassed = true;

            // Extract function name from code (look for function declarations)
            const functionMatch = code.match(/function\s+(\w+)\s*\(/);
            if (!functionMatch) {
                throw new Error('No function found in your code. Please define a function.');
            }
            const functionName = functionMatch[1];

            // Create a safe execution context
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                const startTime = performance.now();

                try {
                    // Parse input - handle different formats
                    const inputStr = testCase.input;
                    const expectedOutput = testCase.output;

                    // Create function in isolated scope and execute
                    const evalCode = `
                        ${code}
                        
                        // Parse input
                        ${parseInputToArgs(inputStr, functionName)}
                        
                        // Execute function
                        const result = ${functionName}(...args);
                        
                        // Return result
                        JSON.stringify(result);
                    `;

                    const actualOutput = eval(evalCode);
                    const endTime = performance.now();
                    const executionTime = (endTime - startTime).toFixed(2);

                    // Compare outputs
                    const passed = normalizeOutput(actualOutput) === normalizeOutput(expectedOutput);

                    if (!passed) allPassed = false;

                    results.push({
                        testNumber: i + 1,
                        input: inputStr,
                        expected: expectedOutput,
                        actual: actualOutput,
                        passed: passed,
                        executionTime: executionTime,
                        explanation: testCase.explanation
                    });

                } catch (error) {
                    allPassed = false;
                    const endTime = performance.now();
                    const executionTime = (endTime - startTime).toFixed(2);

                    results.push({
                        testNumber: i + 1,
                        input: testCase.input,
                        expected: testCase.output,
                        actual: null,
                        passed: false,
                        error: error.message,
                        executionTime: executionTime,
                        explanation: testCase.explanation
                    });
                }
            }

            return {
                allPassed: allPassed,
                results: results,
                passedCount: results.filter(r => r.passed).length,
                totalCount: results.length
            };
        }

        function parseInputToArgs(inputStr, functionName) {
            // Parse input string like "nums = [2,7,11,15], target = 9"
            // into arguments array
            const assignments = inputStr.split(',').map(s => s.trim());
            const args = [];

            for (const assignment of assignments) {
                const parts = assignment.split('=').map(s => s.trim());
                if (parts.length === 2) {
                    let value = parts[1];
                    // Try to evaluate the value
                    try {
                        args.push(JSON.parse(value));
                    } catch {
                        // If not valid JSON, try to eval it
                        args.push(value);
                    }
                }
            }

            return `const args = ${JSON.stringify(args)};`;
        }

        function normalizeOutput(output) {
            // Normalize output for comparison
            if (typeof output === 'string') {
                try {
                    // Try to parse as JSON for comparison
                    const parsed = JSON.parse(output);
                    return JSON.stringify(parsed);
                } catch {
                    return output.trim();
                }
            }
            return JSON.stringify(output);
        }

        function displayTestResults(testResults) {
            const resultsDiv = document.getElementById('results');
            const { allPassed, results, passedCount, totalCount } = testResults;

            let html = `
                <div class="test-case ${allPassed ? 'passed' : 'failed'}">
                    <div class="test-label">
                        ${allPassed ? '‚úÖ All Tests Passed!' : `‚ùå ${passedCount}/${totalCount} Tests Passed`}
                    </div>
                </div>
            `;

            // Add individual test results
            results.forEach(result => {
                const statusIcon = result.passed ? '‚úÖ' : '‚ùå';
                const statusClass = result.passed ? 'passed' : 'failed';

                html += `
                    <div class="test-case ${statusClass}" style="margin-top: 15px;">
                        <div class="test-label">${statusIcon} Test Case ${result.testNumber}</div>
                        <div class="test-result">
                            <div><strong>Input:</strong> ${escapeHtml(result.input)}</div>
                            <div><strong>Expected:</strong> ${escapeHtml(result.expected)}</div>
                            <div><strong>Actual:</strong> ${result.error ? `<span class="error">Error: ${escapeHtml(result.error)}</span>` : escapeHtml(result.actual || 'null')}</div>
                            <div style="color: var(--terminal-text-dim); margin-top: 5px;">
                                ‚è±Ô∏è Execution Time: ${result.executionTime}ms
                            </div>
                            ${result.explanation ? `<div style="margin-top: 5px; color: var(--terminal-text-dim);"><em>${escapeHtml(result.explanation)}</em></div>` : ''}
                        </div>
                    </div>
                `;
            });

            // Add code metrics if all passed
            if (allPassed) {
                const metrics = calculateComplexity(codeEditor.getValue());
                html += `
                    <div class="test-case" style="margin-top: 15px; border-color: var(--accent-secondary);">
                        <div class="test-label">üìä Code Metrics</div>
                        <div class="test-result">
                            <div><strong>Time Complexity:</strong> ${metrics.timeComplexity}</div>
                            <div><strong>Space Complexity:</strong> ${metrics.spaceComplexity}</div>
                            <div><strong>Lines of Code:</strong> ${metrics.lines}</div>
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return 'null';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function submitSolution() {
            if (!codeEditor) return;

            const code = codeEditor.getValue();

            if (!code.trim()) {
                alert('Please write some code first!');
                return;
            }

            const timeTaken = Date.now() - startTime;
            const metrics = calculateComplexity(code);
            const score = calculateScore(metrics, timeTaken);

            // Save solution with language info
            const solutions = JSON.parse(localStorage.getItem('solutions') || '{}');
            solutions[currentProblem.id] = {
                code,
                language: currentLanguage,
                metrics,
                timeTaken,
                score,
                timestamp: Date.now()
            };
            localStorage.setItem('solutions', JSON.stringify(solutions));

            // Update user stats
            const user = JSON.parse(localStorage.getItem('kernalcombat_user') || '{"problemsSolved": 0}');
            user.problemsSolved = (user.problemsSolved || 0) + 1;
            localStorage.setItem('kernalcombat_user', JSON.stringify(user));

            alert(`Solution submitted! Score: ${Math.floor(score)}`);
            window.location.href = 'problems.html';
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent =
                `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function updateLineCount() {
            if (!codeEditor) return;
            const lines = codeEditor.lineCount();
            document.getElementById('lineCount').textContent = lines;
        }

        function navigateTo(page) {
            window.location.href = page;
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('currentTime').textContent = timeStr;
        }

        // Initialize
        window.addEventListener('load', async () => {
            await loadProblem();
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            updateTime();
            setInterval(updateTime, 1000);
        });
    </script>
</body>

</html>